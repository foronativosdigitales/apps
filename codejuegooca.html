    <!-- Panel de informaciÃ³n -->
    <div class="info-panel">
        <div class="info-card">
            <h3>ğŸ‘¤ GuardiÃ¡n</h3>
            <div class="value" id="player-name">Ciber-HÃ©roe</div>
        </div>
        <div class="info-card">
            <h3>ğŸ“ PosiciÃ³n</h3>
            <div class="value" id="player-position">1</div>
        </div>
        <div class="info-card">
            <h3>ğŸ† Puntos</h3>
            <div class="value" id="player-score">0</div>
        </div>
        <div class="info-card">
            <h3>ğŸ›¡ï¸ Nivel</h3>
            <div class="value" id="security-level">Novato</div>
        </div>
    </div>

    <!-- Tablero de juego -->
    <div class="game-board">
        <!-- Contenedor del dado -->
        <div class="dice-container" id="dice-container">
            <div class="dice" id="dice">?</div>
            <button class="dice-btn" id="roll-dice-btn" disabled>ğŸ² Lanzar Dado</button>
        </div>

        <!-- Zonas cibernÃ©ticas -->
        <div class="cyber-zones">
            <div class="zone">ğŸ” ContraseÃ±as<br>Seguras</div>
            <div class="zone">ğŸ‘¥ Privacidad<br>Personal</div>
            <div class="zone">ğŸŒ NavegaciÃ³n<br>Segura</div>
            <div class="zone">ğŸ“± Redes<br>Sociales</div>
            <div class="zone">ğŸ“§ Email &<br>Phishing</div>
            <div class="zone">ğŸ® Gaming<br>Responsable</div>
        </div>

        <!-- Tablero de casillas -->
        <div class="board-path" id="game-path">
            <!-- Las casillas se generarÃ¡n dinÃ¡micamente con JavaScript -->
        </div>

        <!-- Leyenda -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color contraseÃ±as"></div>
                <span>ğŸ” ContraseÃ±as</span>
            </div>
            <div class="legend-item">
                <div class="legend-color privacidad"></div>
                <span>ğŸ‘¥ Privacidad</span>
            </div>
            <div class="legend-item">
                <div class="legend-color navegacion"></div>
                <span>ğŸŒ NavegaciÃ³n</span>
            </div>
            <div class="legend-item">
                <div class="legend-color redes-sociales"></div>
                <span>ğŸ“± Redes Sociales</span>
            </div>
            <div class="legend-item">
                <div class="legend-color special" style="border-color: #ffd700;"></div>
                <span>âœ¨ Casilla Especial</span>
            </div>
            <div class="legend-item">
                <div class="legend-color finish"></div>
                <span>ğŸ Meta</span>
            </div>
        </div>
    </div>

    <!-- Controles -->
    <div class="controls">
        <button class="btn btn-primary" id="start-btn">ğŸš€ Iniciar MisiÃ³n</button>
        <button class="btn btn-secondary" id="reset-btn" disabled>ğŸ”„ Reiniciar</button>
        <button class="btn btn-secondary" id="instructions-btn">â“ Manual del GuardiÃ¡n</button>
    </div>
</div>

<!-- Modal para preguntas -->
<div id="question-modal" class="modal">
    <div class="modal-content">
        <button class="close-btn" id="close-question-modal">Ã—</button>
        <div class="question-header">
            <div id="question-category" class="question-category"></div>
            <div id="question-zone"></div>
        </div>
        <div id="question-text" class="question-text"></div>
        <div id="scenario-section" class="scenario-viewer" style="display: none;">
            <div id="scenario-content" class="scenario-content"></div>
            <div class="scenario-tip">
                ğŸ’¡ <strong>Piensa bien:</strong> Â¿CuÃ¡l serÃ­a la acciÃ³n mÃ¡s segura?
            </div>
        </div>
        <div id="answers" class="answers"></div>
        <div id="explanation" class="explanation"></div>
    </div>
</div>

<!-- Modal de instrucciones -->
<div id="instructions-modal" class="instructions-modal">
    <div class="instructions-content">
        <button class="close-btn" id="close-instructions-modal">Ã—</button>
        <h2 style="text-align: center; margin-bottom: 20px; color: #1a1a4b;">ğŸ“œ Manual del GuardiÃ¡n</h2>
        <div style="margin-bottom: 15px;">
            <h3>ğŸ¯ Objetivo del juego</h3>
            <p>Recorre el tablero respondiendo preguntas sobre seguridad digital para convertirte en un autÃ©ntico Ciber-GuardiÃ¡n. Â¡Alcanza la casilla 60!</p>
        </div>
        <div style="margin-bottom: 15px;">
            <h3>ğŸ“ CÃ³mo jugar</h3>
            <ol>
                <li>Haz clic en "Iniciar MisiÃ³n" para comenzar la aventura.</li>
                <li>Lanza el dado para avanzar por las casillas del tablero.</li>
                <li>Cada casilla te presentarÃ¡ una pregunta de ciberseguridad. Responde correctamente para ganar puntos.</li>
                <li>Algunas casillas especiales te darÃ¡n recompensas o te impondrÃ¡n castigos inesperados.</li>
                <li>Si respondes incorrectamente, se te mostrarÃ¡ una explicaciÃ³n para que aprendas.</li>
                <li>Tu nivel de seguridad aumentarÃ¡ a medida que ganes mÃ¡s puntos. Â¡ConviÃ©rtete en un GuardiÃ¡n!</li>
            </ol>
        </div>
        <div>
            <h3>ğŸ† Sistema de puntos y niveles</h3>
            <ul>
                <li><strong>Respuesta correcta:</strong> +5 puntos (pueden ser mÃ¡s con tarjetas de bonus)</li>
                <li><strong>Respuesta incorrecta:</strong> +0 puntos, pero aprenderÃ¡s con la explicaciÃ³n.</li>
                <li><strong>Niveles:</strong>
                    <ul>
                        <li>Novato: 0-10 puntos</li>
                        <li>Aprendiz: 11-25 puntos</li>
                        <li>Experto: 26-40 puntos</li>
                        <li>GuardiÃ¡n: 41+ puntos</li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class="cyber-tip" style="margin-top: 20px;">
            ğŸ’¡ Cada pregunta es una oportunidad para aprender sobre cÃ³mo protegerte en el mundo digital. Â¡No te rindas!
        </div>
    </div>
</div>

<!-- Modal de tarjetas -->
<div id="card-modal" class="card-modal">
    <div class="card-content">
        <h2 class="card-title" id="card-title">Â¡Tarjeta Especial!</h2>
        <div class="card-effect" id="card-effect">
            Has encontrado una tarjeta especial con efectos en tu juego.
        </div>
        <button class="card-close-btn" id="card-close-btn">Continuar</button>
    </div>
</div>

<!-- NotificaciÃ³n de nivel -->
<div id="level-up" class="level-up">
    Â¡Felicidades! Has alcanzado el nivel: <span id="new-level"></span>
</div>

<!-- Modal de fin de juego -->
<div id="game-over-modal" class="game-over-modal">
    <div class="game-over-content">
        <h2 id="game-over-title">Â¡MisiÃ³n Completada!</h2>
        <p>Â¡Has llegado al final del tablero!</p>
        <p>Tu puntuaciÃ³n final:</p>
        <div class="final-score" id="final-score">0</div>
        <p>Tu nivel de ciberseguridad:</p>
        <div class="final-level" id="final-level">Novato</div>
        <button class="btn btn-primary" id="restart-game-btn">Volver a Jugar</button>
    </div>
</div>

<script>
    // ==================== VARIABLES GLOBALES ====================
    const TOTAL_CELLS = 60;
    const POINTS_PER_QUESTION = 5;

    let gameState = {
        playerPosition: 1,
        playerScore: 0,
        gameActive: false,
        currentQuestion: null,
        securityLevel: 'Novato',
        diceRolled: false, // True if dice was just rolled, awaiting action (question/card)
        diceValue: 0,
        nextBonus: 1, // Multiplier for next correct answer points
        autoCorrect: false, // If true, next answer is automatically correct
        skipTurn: false, // If true, player skips next dice roll
        previousLevel: 'Novato' // To track level changes
    };

    // Referencias a elementos del DOM
    const playerNameEl = document.getElementById('player-name');
    const playerPositionEl = document.getElementById('player-position');
    const playerScoreEl = document.getElementById('player-score');
    const securityLevelEl = document.getElementById('security-level');
    const gamePathEl = document.getElementById('game-path');
    const rollDiceBtn = document.getElementById('roll-dice-btn');
    const diceEl = document.getElementById('dice');
    const startBtn = document.getElementById('start-btn');
    const resetBtn = document.getElementById('reset-btn');
    const instructionsBtn = document.getElementById('instructions-btn');

    const questionModal = document.getElementById('question-modal');
    const closeQuestionModalBtn = document.getElementById('close-question-modal');
    const questionCategoryEl = document.getElementById('question-category');
    const questionZoneEl = document.getElementById('question-zone');
    const questionTextEl = document.getElementById('question-text');
    const answersEl = document.getElementById('answers');
    const explanationEl = document.getElementById('explanation');
    const scenarioSectionEl = document.getElementById('scenario-section');
    const scenarioContentEl = document.getElementById('scenario-content');

    const instructionsModal = document.getElementById('instructions-modal');
    const closeInstructionsModalBtn = document.getElementById('close-instructions-modal');

    const cardModal = document.getElementById('card-modal');
    const cardTitleEl = document.getElementById('card-title');
    const cardEffectEl = document.getElementById('card-effect');
    const cardCloseBtn = document.getElementById('card-close-btn');

    const levelUpNotification = document.getElementById('level-up');
    const newLevelEl = document.getElementById('new-level');

    const gameOverModal = document.getElementById('game-over-modal');
    const gameOverTitleEl = document.getElementById('game-over-title');
    const finalScoreEl = document.getElementById('final-score');
    const finalLevelEl = document.getElementById('final-level');
    const restartGameBtn = document.getElementById('restart-game-btn');


    // Tarjetas especiales (recompensas y castigos)
    const specialCards = {
        rewards: [
            { 
                title: "Â¡BONUS x2!", 
                effect: "Tu prÃ³xima respuesta correcta te da el doble de puntos.", 
                type: "bonus",
                action: function() { gameState.nextBonus = 2; }
            },
            { 
                title: "Â¡BONUS x3!", 
                effect: "Tu prÃ³xima respuesta correcta te da el triple de puntos.", 
                type: "bonus",
                action: function() { gameState.nextBonus = 3; }
            },
            { 
                title: "Â¡AVANCE RÃPIDO!", 
                effect: "Avanzas 3 casillas adicionales.", 
                type: "bonus",
                action: function() {
                    setTimeout(() => { // Small delay for effect
                        movePlayer(Math.min(gameState.playerPosition + 3, TOTAL_CELLS));
                    }, 1000);
                }
            },
            { 
                title: "Â¡RESPUESTA SEGURA!", 
                effect: "Tu prÃ³xima pregunta se considera correcta automÃ¡ticamente.", 
                type: "bonus",
                action: function() { gameState.autoCorrect = true; }
            }
        ],
        penalties: [
            { 
                title: "Â¡VIRUS DETECTADO!", 
                effect: "Retrocedes 2 casillas.", 
                type: "penalty",
                action: function() {
                    setTimeout(() => { // Small delay for effect
                        movePlayer(Math.max(gameState.playerPosition - 2, 1));
                    }, 1000);
                }
            },
            { 
                title: "Â¡REINICIO DEL SISTEMA!", 
                effect: "Vuelves a la casilla de inicio (casilla 1).", 
                type: "penalty",
                action: function() {
                    setTimeout(() => { // Small delay for effect
                        movePlayer(1);
                    }, 1000);
                }
            },
            { 
                title: "Â¡PÃ‰RDIDA DE DATOS!", 
                effect: "Pierdes 5 puntos de tu puntuaciÃ³n actual.", 
                type: "penalty",
                action: function() {
                    gameState.playerScore = Math.max(gameState.playerScore - 5, 0);
                    updatePlayerInfo();
                }
            },
            { 
                title: "Â¡BLOQUEO TEMPORAL!", 
                effect: "Pierdes tu prÃ³ximo turno.", 
                type: "penalty",
                action: function() { gameState.skipTurn = true; }
            }
        ]
    };

    // ==================== BASE DE DATOS DE PREGUNTAS ====================
    const questionDatabase = {
        // CONTRASEÃ‘AS SEGURAS (Rojo)
        contraseÃ±as: [
            {
                zone: "ContraseÃ±as Seguras",
                question: "Â¿CuÃ¡l de estas contraseÃ±as es MÃS segura?",
                options: ["123456", "MiNombre2024", "P@ssw0rd!2024#Segura", "password"],
                correct: 2,
                explanation: "Una contraseÃ±a segura debe tener al menos 12 caracteres, combinar mayÃºsculas, minÃºsculas, nÃºmeros y sÃ­mbolos, y ser Ãºnica.",
                level: "beginner"
            },
            {
                zone: "ContraseÃ±as Seguras",
                question: "Â¿QuÃ© debes hacer si sospechas que alguien sabe tu contraseÃ±a?",
                options: ["Ignorarlo, no pasa nada", "Cambiarla inmediatamente en todos los sitios", "ContÃ¡rselo a mis amigos", "Usar la misma en mÃ¡s sitios"],
                correct: 1,
                explanation: "Si crees que tu contraseÃ±a estÃ¡ comprometida, cÃ¡mbiala de inmediato en todas las cuentas donde la uses para protegerte.",
                level: "beginner"
            },
            {
                zone: "ContraseÃ±as Seguras",
                question: "Â¿Es seguro usar la misma contraseÃ±a para todas mis cuentas?",
                options: ["SÃ­, es mÃ¡s fÃ¡cil recordarla", "No, si la descubren acceden a todo", "Solo para redes sociales", "Depende de la contraseÃ±a"],
                correct: 1,
                explanation: "Usar la misma contraseÃ±a en mÃºltiples sitios es muy peligroso. Si la descubren, tendrÃ¡n acceso a todas tus cuentas. Â¡Usa contraseÃ±as Ãºnicas!",
                level: "intermediate"
            },
            {
                zone: "ContraseÃ±as Seguras",
                question: "Â¿QuÃ© es un gestor de contraseÃ±as y para quÃ© sirve?",
                options: ["Un juego de ordenador", "Un programa que guarda y genera contraseÃ±as de forma segura", "Una red social", "Un tipo de virus"],
                correct: 1,
                explanation: "Un gestor de contraseÃ±as almacena todas tus contraseÃ±as de forma segura, genera contraseÃ±as fuertes y te ayuda a gestionarlas.",
                level: "intermediate"
            },
            {
                zone: "ContraseÃ±as Seguras",
                question: "Â¿Por quÃ© se recomienda la autenticaciÃ³n de dos factores (2FA)?",
                options: ["Porque es mÃ¡s complicado", "Para aumentar la seguridad de la cuenta", "Solo es Ãºtil para cuentas bancarias", "No tiene utilidad real"],
                correct: 1,
                explanation: "La 2FA aÃ±ade una capa extra de seguridad. AdemÃ¡s de la contraseÃ±a, necesitas un segundo mÃ©todo de verificaciÃ³n (ej. un cÃ³digo a tu mÃ³vil).",
                level: "advanced"
            },
            {
                zone: "ContraseÃ±as Seguras",
                question: "Si una web te pide tu contraseÃ±a actual para cambiarla, Â¿quÃ© debes evitar?",
                options: ["Usar la misma contraseÃ±a para la nueva", "Usar una contraseÃ±a simple", "Usar una contraseÃ±a que ya hayas usado", "Todas las anteriores"],
                correct: 3,
                explanation: "Al cambiar una contraseÃ±a, siempre crea una nueva, compleja y diferente a las que ya uses, para maximizar la seguridad.",
                level: "advanced"
            }
        ],

        // PRIVACIDAD PERSONAL (Verde)  
        privacidad: [
            {
                zone: "Privacidad Personal",
                question: "Â¿QuÃ© informaciÃ³n personal NO deberÃ­as compartir online con desconocidos?",
                options: ["Tu color favorito", "Tu direcciÃ³n de casa o nÃºmero de telÃ©fono", "Tu comida preferida", "Tu serie favorita"],
                correct: 1,
                explanation: "Nunca compartas informaciÃ³n personal identificable como tu direcciÃ³n, telÃ©fono o dÃ³nde estudias con personas que no conoces online.",
                level: "beginner"
            },
            {
                zone: "Privacidad Personal",
                question: "Si alguien que no conoces te pide tu nÃºmero de telÃ©fono en internet, Â¿quÃ© haces?",
                options: ["Se lo doy si parece simpÃ¡tico", "No se lo doy y se lo cuento a un adulto de confianza", "Le doy un nÃºmero falso", "Le pido el suyo primero"],
                correct: 1,
                explanation: "Nunca des tu informaciÃ³n personal a desconocidos online. Siempre busca el consejo de un adulto de confianza.",
                level: "beginner",
                scenario: "Un chico/a que dice tener tu edad te escribe por primera vez en una app de juegos y te pide tu nÃºmero de telÃ©fono para 'ser mejores amigos'."
            },
            {
                zone: "Privacidad Personal",
                question: "Â¿QuÃ© son los datos personales?",
                options: ["Solo mi nombre completo", "Cualquier informaciÃ³n que me identifica o me hace identificable como persona", "Solo mis fotos", "Solo mi edad"],
                correct: 1,
                explanation: "Los datos personales incluyen tu nombre, direcciÃ³n, telÃ©fono, fotos, ubicaciÃ³n, datos biomÃ©tricos y cualquier informaciÃ³n que te identifique directa o indirectamente.",
                level: "intermediate"
            },
            {
                zone: "Privacidad Personal",
                question: "Â¿Por quÃ© es importante revisar y configurar la privacidad de tus redes sociales y apps?",
                options: ["No es importante", "Para saber quÃ© informaciÃ³n tuya pueden ver y usar otros", "Solo si soy mayor de edad", "Para ganar puntos en juegos"],
                correct: 1,
                explanation: "La configuraciÃ³n de privacidad te permite controlar quiÃ©n ve tu contenido, tus publicaciones y quÃ© informaciÃ³n personal compartes con las apps y otras personas.",
                level: "intermediate"
            },
            {
                zone: "Privacidad Personal",
                question: "Â¿QuÃ© significa el concepto de 'huella digital' o 'rastro digital'?",
                options: ["La forma en que uso mi dedo para desbloquear el mÃ³vil", "El rastro de datos e informaciÃ³n que dejamos al usar internet", "Un programa para dibujar", "La cantidad de likes que tengo"],
                correct: 1,
                explanation: "Tu huella digital es el conjunto de informaciÃ³n que generas y dejas en internet, incluyendo publicaciones, comentarios, bÃºsquedas y datos de uso de apps. Es importante gestionarla.",
                level: "advanced"
            },
            {
                zone: "Privacidad Personal",
                question: "Â¿QuÃ© medida es la mÃ¡s efectiva para proteger tu privacidad al usar Wi-Fi pÃºblico?",
                options: ["Conectarse a cualquier red sin preguntar", "Compartir toda mi informaciÃ³n con otros", "Usar una Red Privada Virtual (VPN)", "Navegar solo por sitios conocidos"],
                correct: 2,
                explanation: "Una VPN (Red Privada Virtual) cifra tu conexiÃ³n a internet, protegiendo tus datos de posibles intrusos en redes Wi-Fi pÃºblicas no seguras.",
                level: "advanced"
            }
        ],

        // NAVEGACIÃ“N SEGURA (Azul)
        navegacion: [
            {
                zone: "NavegaciÃ³n Segura",
                question: "Â¿CÃ³mo puedes saber si una pÃ¡gina web es segura antes de introducir datos sensibles?",
                options: ["Si es bonita y tiene muchas imÃ¡genes", "Si tiene un candado ğŸ”’ y empieza por https://", "Si tiene muchos anuncios", "Si carga rÃ¡pido"],
                correct: 1,
                explanation: "Busca siempre el candado cerrado en la barra de direcciones y asegÃºrate de que la URL empieza por 'https://'. Esto indica que la conexiÃ³n es segura.",
                level: "beginner"
            },
            {
                zone: "NavegaciÃ³n Segura",
                question: "Un enlace te llega por un mensaje de un desconocido, prometiendo un premio. Â¿QuÃ© haces?",
                options: ["Hago clic inmediatamente para reclamar el premio", "Comparto el enlace con mis amigos", "Lo ignoro y lo borro, podrÃ­a ser 'phishing'", "Lo guardo para verlo despuÃ©s"],
                correct: 2,
                explanation: "Muchos ataques de 'phishing' intentan engaÃ±arte con premios falsos para robar tus datos. Nunca hagas clic en enlaces sospechosos.",
                level: "beginner"
            },
            {
                zone: "Navegacion Segura",
                question: "Â¿QuÃ© es un 'pop-up' o ventana emergente y cÃ³mo debes actuar ante uno sospechoso?",
                options: ["Un juego divertido", "Una ventana que aparece de repente; ciÃ©rrala cuidadosamente o no hagas clic en ella", "Un tipo de virus que debes abrir", "Publicidad inofensiva"],
                correct: 1,
                explanation: "Las ventanas emergentes sospechosas a menudo son trampas. CiÃ©rralas con la 'X' o cerrando la pestaÃ±a, y nunca hagas clic en ellas.",
                level: "intermediate"
            },
            {
                zone: "Navegacion Segura",
                question: "Â¿QuÃ© son los 'cookies' y por quÃ© las webs te piden aceptarlas?",
                options: ["Un tipo de galleta virtual", "PequeÃ±os archivos que guardan informaciÃ³n sobre tu navegaciÃ³n para mejorar tu experiencia o para publicidad", "Un virus", "Un juego online"],
                correct: 1,
                explanation: "Las cookies ayudan a las webs a recordar tus preferencias. Aceptarlas es comÃºn, pero siempre es bueno revisar la polÃ­tica de privacidad de cada sitio.",
                level: "intermediate"
            },
            {
                zone: "Navegacion Segura",
                question: "Â¿QuÃ© indica el prefijo 'http' en lugar de 'https' en una direcciÃ³n web?",
                options: ["Que la pÃ¡gina es antigua", "Que la conexiÃ³n no es segura y tus datos podrÃ­an ser interceptados", "Que es una pÃ¡gina muy rÃ¡pida", "Que es una pÃ¡gina de confianza"],
                correct: 1,
                explanation: "HTTP (Hypertext Transfer Protocol) no cifra la comunicaciÃ³n, lo que la hace vulnerable. HTTPS (Secure) sÃ­ la cifra, protegiendo tus datos.",
                level: "advanced"
            },
            {
                zone: "Navegacion Segura",
                question: "Â¿CuÃ¡l es la mejor forma de actuar si, al navegar, aparece una alerta de tu antivirus diciendo que has visitado un sitio peligroso?",
                options: ["Ignorar la alerta y continuar navegando", "Desactivar el antivirus porque molesta", "Cerrar inmediatamente la ventana y salir de la pÃ¡gina", "Reiniciar el ordenador y volver a la misma pÃ¡gina"],
                correct: 2,
                explanation: "Las alertas de antivirus son importantes. Debes cerrar la pÃ¡gina de inmediato y escanear tu dispositivo para asegurarte de que no haya sido afectado.",
                level: "advanced"
            }
        ],

        // REDES SOCIALES (Naranja)
        redes_sociales: [
            {
                zone: "Redes Sociales",
                question: "Â¿Es seguro aceptar a todos los que te mandan una solicitud de amistad en redes sociales?",
                options: ["SÃ­, cuantos mÃ¡s amigos mejor", "No, solo a personas que conoces y en quienes confÃ­as", "Solo si tienen fotos bonitas", "Depende de la red social"],
                correct: 1,
                explanation: "Aceptar a desconocidos puede exponer tu informaciÃ³n personal a personas con malas intenciones. MantÃ©n tu cÃ­rculo de amigos limitado a quienes conoces en la vida real.",
                level: "beginner"
            },
            {
                zone: "Redes Sociales",
                question: "Â¿QuÃ© tipo de fotos NO deberÃ­as compartir en redes sociales de forma pÃºblica?",
                options: ["Fotos de tus mascotas", "Fotos que revelan tu ubicaciÃ³n exacta, tu escuela o tu casa", "Fotos de tus dibujos", "Selfies divertidos"],
                correct: 1,
                explanation: "Evita compartir fotos que puedan dar pistas sobre dÃ³nde vives, estudias o tus rutinas, ya que pueden ser usadas por personas peligrosas.",
                level: "beginner"
            },
            {
                zone: "Redes Sociales",
                question: "Â¿QuÃ© debes hacer si ves a alguien siendo vÃ­ctima de 'ciberbullying' en una red social?",
                options: ["Unirme y reÃ­rme", "Ignorarlo, no es mi problema", "Reportarlo a la plataforma y apoyar a la vÃ­ctima", "Compartirlo para que mÃ¡s gente lo vea"],
                correct: 2,
                explanation: "Reporta siempre el ciberbullying a la plataforma y busca la manera de apoyar a la vÃ­ctima. No seas parte del problema.",
                level: "intermediate"
            },
            {
                zone: "Redes Sociales",
                question: "Â¿CuÃ¡l es una buena prÃ¡ctica para proteger tu perfil en redes sociales?",
                options: ["Dejarlo pÃºblico para que todos lo vean", "Usar tu nombre completo y fecha de nacimiento exactos", "Configurar la privacidad para que solo tus amigos vean tus publicaciones", "Publicar todo sin pensar"],
                correct: 2,
                explanation: "Configurar tu perfil como privado y revisar quiÃ©n puede ver tus publicaciones es fundamental para proteger tu informaciÃ³n.",
                level: "intermediate"
            },
            {
                zone: "Redes Sociales",
                question: "Â¿Por quÃ© es peligroso participar en 'retos virales' sin conocer su origen o implicaciones?",
                options: ["Porque son aburridos", "Pueden ser riesgosos para tu seguridad fÃ­sica o tu privacidad", "Porque mucha gente ya los ha hecho", "No tienen ningÃºn peligro real"],
                correct: 1,
                explanation: "Algunos retos virales pueden llevar a situaciones peligrosas en la vida real, exponer informaciÃ³n personal o hacerte caer en estafas. Investiga siempre antes de participar.",
                level: "advanced"
            },
            {
                zone: "Redes Sociales",
                question: "Â¿QuÃ© es la 'suplantaciÃ³n de identidad' (impersonation) en redes sociales?",
                options: ["Cuando alguien usa tu foto de perfil", "Cuando alguien se hace pasar por otra persona para engaÃ±ar o daÃ±ar", "Cuando usas filtros en tus fotos", "Cuando cambias tu nombre de usuario"],
                correct: 1,
                explanation: "La suplantaciÃ³n de identidad es cuando una persona se hace pasar por otra, a menudo para obtener informaciÃ³n o daÃ±ar su reputaciÃ³n. Siempre verifica la autenticidad de los perfiles.",
                level: "advanced"
            }
        ],
        // Email & Phishing (AÃ±adirÃ© algunas preguntas de ejemplo)
        email_phishing: [
            {
                zone: "Email & Phishing",
                question: "Â¿QuÃ© NO debes hacer si recibes un correo electrÃ³nico de un banco desconocido que te pide tus datos personales?",
                options: ["Responder con mis datos inmediatamente", "Verificar la direcciÃ³n del remitente", "No hacer clic en enlaces sospechosos", "Borrar el correo"],
                correct: 0,
                explanation: "Los bancos y empresas legÃ­timas NUNCA te pedirÃ¡n informaciÃ³n personal sensible por correo electrÃ³nico. Es casi seguro un intento de 'phishing'.",
                level: "beginner"
            },
            {
                zone: "Email & Phishing",
                question: "Â¿QuÃ© es el 'phishing'?",
                options: ["Un tipo de pesca", "Una tÃ©cnica de engaÃ±o para obtener informaciÃ³n confidencial haciÃ©ndose pasar por una entidad de confianza", "Un programa para editar fotos", "Una forma de jugar online"],
                correct: 1,
                explanation: "El phishing es una estafa online donde los atacantes intentan robar tus datos (contraseÃ±as, datos bancarios) haciÃ©ndose pasar por organizaciones legÃ­timas.",
                level: "intermediate"
            },
            {
                zone: "Email & Phishing",
                question: "Recibes un email de un amigo que te pide dinero URGENTE, pero el tono no parece suyo. Â¿QuÃ© haces?",
                options: ["Le envÃ­o el dinero inmediatamente", "Lo ignoro", "Intento contactar a mi amigo por otro medio (telÃ©fono, mensaje) para confirmar", "ReenvÃ­o el correo a otros amigos"],
                correct: 2,
                explanation: "PodrÃ­a ser que la cuenta de tu amigo haya sido comprometida. Siempre verifica la informaciÃ³n por otro medio antes de actuar.",
                level: "advanced"
            }
        ],
        // Gaming Responsable (AÃ±adirÃ© algunas preguntas de ejemplo)
        gaming_responsable: [
            {
                zone: "Gaming Responsable",
                question: "Â¿QuÃ© debes hacer si un desconocido en un juego online te pide informaciÃ³n personal como tu nombre completo o direcciÃ³n?",
                options: ["DÃ¡rsela, asÃ­ pueden ser mejores amigos", "Decir que no y no compartir informaciÃ³n personal", "Inventar informaciÃ³n falsa", "Bloquearlo inmediatamente"],
                correct: 1, // Changed to 1 as giving false info can also be risky, blocking is a good step after refusing.
                explanation: "Nunca compartas informaciÃ³n personal identificable con desconocidos en juegos online. Es importante proteger tu identidad.",
                level: "beginner"
            },
            {
                zone: "Gaming Responsable",
                question: "Â¿Por quÃ© es importante usar contraseÃ±as fuertes y Ãºnicas para tus cuentas de juegos?",
                options: ["Para que nadie te gane", "Para proteger tus progresos, compras y datos personales de ser robados", "No es importante, solo son juegos", "Para molestar a otros jugadores"],
                correct: 1,
                explanation: "Tus cuentas de juego pueden contener mucha informaciÃ³n personal y de pago. Protegerlas con contraseÃ±as fuertes es esencial.",
                level: "intermediate"
            },
            {
                zone: "Gaming Responsable",
                question: "Un jugador te insulta o te acosa repetidamente en un juego online. Â¿CuÃ¡l es la mejor acciÃ³n?",
                options: ["Devolverle los insultos", "Ignorarlo y esperar que pare", "Reportar al jugador a los moderadores del juego y bloquearlo", "Dejar de jugar para siempre"],
                correct: 2,
                explanation: "No toleres el acoso. Usa las herramientas de reporte y bloqueo del juego. Si persiste, habla con un adulto de confianza.",
                level: "advanced"
            }
        ]
    };

    // Keep track of asked questions to avoid repetition
    const askedQuestions = {
        contraseÃ±as: [], privacidad: [], navegacion: [], redes_sociales: [], email_phishing: [], gaming_responsable: []
    };

    // Map categories to their CSS classes
    const categoryClasses = {
        contraseÃ±as: 'contraseÃ±as',
        privacidad: 'privacidad',
        navegacion: 'navegacion',
        redes_sociales: 'redes-sociales',
        email_phishing: 'email-phishing', // Though not explicitly styled, good to keep
        gaming_responsable: 'gaming-responsable' // Same
    };

    const levelPoints = {
        'Novato': 0,
        'Aprendiz': 11,
        'Experto': 26,
        'GuardiÃ¡n': 41
    };

    const levelNames = ['Novato', 'Aprendiz', 'Experto', 'GuardiÃ¡n'];

    // ==================== FUNCIONES DE JUEGO ====================

    function initGame() {
        gameState.playerScore = 0;
        gameState.playerPosition = 1;
        gameState.gameActive = false;
        gameState.diceRolled = false;
        gameState.diceValue = 0;
        gameState.nextBonus = 1;
        gameState.autoCorrect = false;
        gameState.skipTurn = false;
        gameState.securityLevel = 'Novato';
        gameState.previousLevel = 'Novato';
        resetAskedQuestions();
        updatePlayerInfo();
        generateBoard();
        
        startBtn.disabled = false;
        resetBtn.disabled = true;
        rollDiceBtn.disabled = true;
        diceEl.textContent = '?';
        
        hideAllModals();
    }

    function resetAskedQuestions() {
        for (const category in askedQuestions) {
            askedQuestions[category] = [];
        }
    }

    function updatePlayerInfo() {
        playerPositionEl.textContent = gameState.playerPosition;
        playerScoreEl.textContent = gameState.playerScore;
        
        const oldLevel = gameState.securityLevel;
        checkSecurityLevel();
        securityLevelEl.textContent = gameState.securityLevel;
        securityLevelEl.className = `value security-level level-${gameState.securityLevel.toLowerCase()}`;

        if (gameState.gameActive && oldLevel !== gameState.securityLevel && gameState.securityLevel !== 'Novato') {
            showLevelUpNotification(gameState.securityLevel);
        }
    }

    function checkSecurityLevel() {
        let newLevel = 'Novato';
        if (gameState.playerScore >= levelPoints['GuardiÃ¡n']) {
            newLevel = 'GuardiÃ¡n';
        } else if (gameState.playerScore >= levelPoints['Experto']) {
            newLevel = 'Experto';
        } else if (gameState.playerScore >= levelPoints['Aprendiz']) {
            newLevel = 'Aprendiz';
        }
        gameState.securityLevel = newLevel;
    }

    function showLevelUpNotification(level) {
        newLevelEl.textContent = level;
        levelUpNotification.style.display = 'block';
        levelUpNotification.className = `level-up level-${level.toLowerCase()}`;
        setTimeout(() => {
            levelUpNotification.style.display = 'none';
        }, 2000); // Display for 2 seconds
    }

    function generateBoard() {
        gamePathEl.innerHTML = ''; // Clear existing board
        const categories = Object.keys(questionDatabase);
        let categoryIndex = 0;

        for (let i = 1; i <= TOTAL_CELLS; i++) {
            const cell = document.createElement('div');
            cell.classList.add('cell');
            cell.id = `cell-${i}`;
            cell.textContent = i;

            if (i === TOTAL_CELLS) {
                cell.classList.add('finish');
            } else if ([10, 20, 30, 40, 50, 55].includes(i)) {
                cell.classList.add('special'); // Special card cells
            } else {
                const categoryName = categories[categoryIndex % categories.length];
                cell.classList.add(categoryClasses[categoryName]);
                cell.dataset.category = categoryName;
                categoryIndex++;
            }
            
            gamePathEl.appendChild(cell);
        }
        updatePlayerPositionOnBoard();
    }

    function updatePlayerPositionOnBoard() {
        const cells = document.querySelectorAll('.cell');
        cells.forEach(cell => cell.classList.remove('active'));
        
        const currentCell = document.getElementById(`cell-${gameState.playerPosition}`);
        if (currentCell) {
            currentCell.classList.add('active');
            // Remove existing token and add a new one
            const existingToken = document.querySelector('.player-token');
            if (existingToken) existingToken.remove();
            
            const playerToken = document.createElement('div');
            playerToken.classList.add('player-token');
            playerToken.textContent = 'ğŸš€'; // Player icon
            currentCell.appendChild(playerToken);
        }
    }

    function rollDice() {
        if (!gameState.gameActive || gameState.diceRolled) return;

        rollDiceBtn.disabled = true; // Disable button during roll
        diceEl.textContent = ''; // Clear dice display
        let rollCount = 0;
        const rollInterval = setInterval(() => {
            diceEl.textContent = Math.floor(Math.random() * 6) + 1;
            rollCount++;
            if (rollCount > 10) { // Simulate rolling for a short time
                clearInterval(rollInterval);
                const diceResult = Math.floor(Math.random() * 6) + 1;
                diceEl.textContent = diceResult;
                gameState.diceValue = diceResult;
                movePlayer(gameState.playerPosition + diceResult);
            }
        }, 100);
    }

    function movePlayer(newPosition) {
        const oldPosition = gameState.playerPosition;
        gameState.playerPosition = Math.min(newPosition, TOTAL_CELLS);
        updatePlayerInfo(); // Update position display immediately
        
        // Animation for movement (optional, but nice)
        const animationSteps = Math.abs(gameState.playerPosition - oldPosition);
        let currentAnimatedPosition = oldPosition;
        const playerToken = document.querySelector('.player-token'); // Get the token

        const moveInterval = setInterval(() => {
            // Clear active class from previous cell
            const prevCell = document.getElementById(`cell-${currentAnimatedPosition}`);
            if (prevCell) prevCell.classList.remove('active');

            if (currentAnimatedPosition < gameState.playerPosition) {
                currentAnimatedPosition++;
            } else if (currentAnimatedPosition > gameState.playerPosition) {
                currentAnimatedPosition--;
            }

            const targetCell = document.getElementById(`cell-${currentAnimatedPosition}`);
            if (targetCell) {
                targetCell.classList.add('active');
                // Move the actual token element
                if (playerToken) {
                    targetCell.appendChild(playerToken);
                }
            }

            if (currentAnimatedPosition === gameState.playerPosition) {
                clearInterval(moveInterval);
                setTimeout(handleCellAction, 500); // Small delay before action
            }
        }, 300); // Speed of animation between cells
    }

    function handleCellAction() {
        if (gameState.playerPosition === TOTAL_CELLS) {
            endGame(true); // Player reached the end
            return;
        }

        const currentCell = document.getElementById(`cell-${gameState.playerPosition}`);
        if (currentCell.classList.contains('special')) {
            triggerSpecialCard();
        } else {
            showQuestionForCurrentCell();
        }
    }

    function triggerSpecialCard() {
        rollDiceBtn.disabled = true; // Ensure dice button is disabled during card event

        let cardList = [];
        if (Math.random() < 0.6) { // 60% chance of penalty, 40% chance of reward
            cardList = specialCards.penalties;
        } else {
            cardList = specialCards.rewards;
        }

        const card = cardList[Math.floor(Math.random() * cardList.length)];
        showCardModal(card);
    }

    function showCardModal(card) {
        cardModal.style.display = 'flex';
        cardTitleEl.textContent = card.title;
        cardEffectEl.textContent = card.effect;
        cardEffectEl.className = `card-effect ${card.type}-card`; // Apply bonus/penalty style

        cardCloseBtn.onclick = () => {
            cardModal.style.display = 'none';
            card.action(); // Apply the card's effect
            // After card action, re-enable dice if game is still active and not skipping turn
            if (gameState.gameActive && !gameState.skipTurn) {
                rollDiceBtn.disabled = false;
            } else if (gameState.skipTurn) {
                alert("Â¡Turno perdido! No puedes lanzar el dado en este turno.");
                gameState.skipTurn = false; // Reset after one turn
                rollDiceBtn.disabled = false;
            }
        };
    }

    function getQuestion(category) {
        let availableQuestions = questionDatabase[category].filter(q => !askedQuestions[category].includes(q));

        if (availableQuestions.length === 0) {
            // If all questions in this category have been asked, reset them
            askedQuestions[category] = [];
            availableQuestions = questionDatabase[category];
        }

        const randomIndex = Math.floor(Math.random() * availableQuestions.length);
        const question = availableQuestions[randomIndex];
        askedQuestions[category].push(question); // Mark as asked
        return question;
    }

    function showQuestionForCurrentCell() {
        const currentCell = document.getElementById(`cell-${gameState.playerPosition}`);
        const category = currentCell.dataset.category;
        const question = getQuestion(category);
        gameState.currentQuestion = question;

        questionModal.style.display = 'flex';
        questionCategoryEl.textContent = `CategorÃ­a: ${question.zone}`;
        questionCategoryEl.className = `question-category ${categoryClasses[category]}`; // Apply color
        questionTextEl.textContent = question.question;
        answersEl.innerHTML = '';
        explanationEl.style.display = 'none'; // Hide explanation initially

        if (question.scenario) {
            scenarioContentEl.textContent = question.scenario;
            scenarioSectionEl.style.display = 'block';
        } else {
            scenarioSectionEl.style.display = 'none';
        }

        question.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.classList.add('answer-btn');
            button.textContent = option;
            button.onclick = () => checkAnswer(index, question);
            answersEl.appendChild(button);
        });
    }

    function checkAnswer(selectedIndex, question) {
        // Disable all answer buttons after selection
        Array.from(answersEl.children).forEach(btn => btn.disabled = true);

        const isCorrect = (selectedIndex === question.correct) || gameState.autoCorrect;
        
        const explanationText = question.explanation;
        explanationEl.textContent = explanationText;
        explanationEl.style.display = 'block';

        if (isCorrect) {
            answersEl.children[selectedIndex].classList.add('correct');
            let pointsEarned = POINTS_PER_QUESTION * gameState.nextBonus;
            gameState.playerScore += pointsEarned;
            alert(`Â¡Correcto! Has ganado ${pointsEarned} puntos.`);
        } else {
            answersEl.children[selectedIndex].classList.add('incorrect');
            answersEl.children[question.correct].classList.add('correct'); // Highlight correct answer
            alert("Â¡Incorrecto! Aprende de tu error.");
        }
        
        gameState.nextBonus = 1; // Reset bonus multiplier
        gameState.autoCorrect = false; // Reset auto-correct

        updatePlayerInfo();

        // Allow closing modal after a short delay to read explanation
        setTimeout(() => {
            closeQuestionModalBtn.style.display = 'block'; // Show close button
        }, 1500); 
    }

    function closeQuestionModal() {
        questionModal.style.display = 'none';
        // Reset buttons state for next question
        Array.from(answersEl.children).forEach(btn => {
            btn.classList.remove('correct', 'incorrect');
            btn.disabled = false;
        });
        explanationEl.style.display = 'none';
        closeQuestionModalBtn.style.display = 'none'; // Hide close button for next time
        
        // Re-enable dice button if game is active
        if (gameState.gameActive && !gameState.skipTurn) {
            rollDiceBtn.disabled = false;
        } else if (gameState.skipTurn) {
            alert("Â¡Turno perdido! No puedes lanzar el dado en este turno.");
            gameState.skipTurn = false; // Reset after one turn
            rollDiceBtn.disabled = false;
        }
    }

    function startGame() {
        if (gameState.gameActive) return;
        gameState.gameActive = true;
        startBtn.disabled = true;
        resetBtn.disabled = false;
        rollDiceBtn.disabled = false;
        initGame(); // Re-initialize game state, board etc.
        alert("Â¡MisiÃ³n iniciada! Lanza el dado para comenzar.");
    }

    function resetGame() {
        if (!confirm('Â¿EstÃ¡s seguro de que quieres reiniciar el juego?')) {
            return;
        }
        initGame();
        alert("Juego reiniciado.");
    }

    function endGame(won) {
        gameState.gameActive = false;
        rollDiceBtn.disabled = true;
        startBtn.disabled = false; // Allow starting a new game
        
        gameOverModal.style.display = 'flex';
        if (won) {
            gameOverTitleEl.textContent = "Â¡CIBER-GUARDIÃN COMPLETO!";
            gameOverTitleEl.style.color = '#48bb78';
        } else {
            // This path might be less common if the only win condition is reaching the end
            // But good to have a general "game over"
            gameOverTitleEl.textContent = "Â¡MisiÃ³n Finalizada!";
            gameOverTitleEl.style.color = '#e53e3e';
        }
        finalScoreEl.textContent = gameState.playerScore;
        finalLevelEl.textContent = gameState.securityLevel;
    }

    function restartFromGameOver() {
        gameOverModal.style.display = 'none';
        initGame();
    }

    function showInstructions() {
        instructionsModal.style.display = 'flex';
    }

    function closeInstructions() {
        instructionsModal.style.display = 'none';
    }

    function hideAllModals() {
        questionModal.style.display = 'none';
        instructionsModal.style.display = 'none';
        cardModal.style.display = 'none';
        gameOverModal.style.display = 'none';
    }

    // ==================== EVENT LISTENERS ====================
    rollDiceBtn.addEventListener('click', rollDice);
    startBtn.addEventListener('click', startGame);
    resetBtn.addEventListener('click', resetGame);
    instructionsBtn.addEventListener('click', showInstructions);
    closeInstructionsModalBtn.addEventListener('click', closeInstructions);
    closeQuestionModalBtn.addEventListener('click', closeQuestionModal);
    cardCloseBtn.addEventListener('click', () => cardModal.style.display = 'none'); // Handled within showCardModal now
    restartGameBtn.addEventListener('click', restartFromGameOver);

    // Initialize the game when the page loads
    document.addEventListener('DOMContentLoaded', initGame);

</script>